name: Gateway Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: packages/gateway/go.mod

      - name: Build binary
        working-directory: packages/gateway
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME}"
          BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          DIST_DIR="dist/${VERSION}"
          OUT="${DIST_DIR}/chatcode-gateway-${{ matrix.goos }}-${{ matrix.goarch }}"

          mkdir -p "${DIST_DIR}"
          CGO_ENABLED=0 GOOS="${{ matrix.goos }}" GOARCH="${{ matrix.goarch }}" \
            go build -ldflags "-X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -s -w" \
            -o "${OUT}" ./cmd/gateway

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: gateway-bin-${{ matrix.goos }}-${{ matrix.goarch }}
          path: packages/gateway/dist/${{ github.ref_name }}/chatcode-gateway-${{ matrix.goos }}-${{ matrix.goarch }}

  bundle:
    name: Assemble Release Bundle
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          pattern: gateway-bin-*
          merge-multiple: true
          path: packages/gateway/dist/${{ github.ref_name }}

      - name: Assemble scripts + checksums
        working-directory: packages/gateway
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME}"
          DIST_DIR="dist/${VERSION}"

          : > "${DIST_DIR}/checksums.txt"
          for file in "${DIST_DIR}"/chatcode-gateway-*; do
            [[ -f "${file}" ]] || continue
            sha="$(sha256sum "${file}" | awk '{print $1}')"
            printf '%s\n' "${sha}" > "${file}.sha256"
            printf '%s  %s\n' "${sha}" "$(basename "${file}")" >> "${DIST_DIR}/checksums.txt"
          done

          cp deploy/manual-install.sh "${DIST_DIR}/manual-install.sh"
          cp deploy/manual-install.sh "${DIST_DIR}/install.sh"
          cp deploy/gateway-cleanup.sh "${DIST_DIR}/gateway-cleanup.sh"
          cp deploy/cloud-init.sh "${DIST_DIR}/cloud-init.sh"
          cp deploy/chatcode-gateway.service "${DIST_DIR}/chatcode-gateway.service"
          chmod +x "${DIST_DIR}/manual-install.sh" "${DIST_DIR}/install.sh" "${DIST_DIR}/gateway-cleanup.sh" "${DIST_DIR}/cloud-init.sh"
          printf '%s\n' "${VERSION}" > "${DIST_DIR}/latest.txt"

          cat > "${DIST_DIR}/manifest.json" <<JSON
          {
            "version": "${VERSION}",
            "targets": ["linux/amd64", "linux/arm64", "darwin/arm64"]
          }
          JSON

      - name: Upload release bundle
        uses: actions/upload-artifact@v4
        with:
          name: gateway-release-bundle
          path: packages/gateway/dist/${{ github.ref_name }}

  github-release:
    name: Publish GitHub Release Assets
    runs-on: ubuntu-latest
    needs: bundle

    steps:
      - name: Download release bundle
        uses: actions/download-artifact@v4
        with:
          name: gateway-release-bundle
          path: dist/${{ github.ref_name }}

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ github.ref_name }}/*

  publish-r2:
    name: Publish Release Bundle to R2
    runs-on: ubuntu-latest
    needs: bundle
    if: ${{ secrets.CF_ACCOUNT_ID != '' && secrets.CF_API_TOKEN_R2_RELEASES != '' && secrets.R2_RELEASE_BUCKET != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download release bundle
        uses: actions/download-artifact@v4
        with:
          name: gateway-release-bundle
          path: packages/gateway/dist/${{ github.ref_name }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Wrangler
        run: npm install -g wrangler@4.68.1

      - name: Publish to R2
        working-directory: packages/gateway
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN_R2_RELEASES }}
          RELEASE_PREFIX: gateway
        run: ./scripts/publish-release-r2.sh "${GITHUB_REF_NAME}" "${{ secrets.R2_RELEASE_BUCKET }}"
