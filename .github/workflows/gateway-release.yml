name: Gateway Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: packages/gateway/go.mod
          cache-dependency-path: packages/gateway/go.sum

      - name: Build binary
        working-directory: packages/gateway
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME}"
          BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          DIST_DIR="dist/${VERSION}"
          OUT="${DIST_DIR}/chatcode-gateway-${{ matrix.goos }}-${{ matrix.goarch }}"

          mkdir -p "${DIST_DIR}"
          CGO_ENABLED=0 GOOS="${{ matrix.goos }}" GOARCH="${{ matrix.goarch }}" \
            go build -ldflags "-X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -s -w" \
            -o "${OUT}" ./cmd/gateway

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: gateway-bin-${{ matrix.goos }}-${{ matrix.goarch }}
          path: packages/gateway/dist/${{ github.ref_name }}/chatcode-gateway-${{ matrix.goos }}-${{ matrix.goarch }}

  bundle:
    name: Assemble Release Bundle
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          pattern: gateway-bin-*
          merge-multiple: true
          path: packages/gateway/dist/${{ github.ref_name }}

      - name: Assemble scripts + checksums
        working-directory: packages/gateway
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME}"
          DIST_DIR="dist/${VERSION}"

          : > "${DIST_DIR}/checksums.txt"
          for file in "${DIST_DIR}"/chatcode-gateway-*; do
            [[ -f "${file}" ]] || continue
            sha="$(sha256sum "${file}" | awk '{print $1}')"
            printf '%s\n' "${sha}" > "${file}.sha256"
            printf '%s  %s\n' "${sha}" "$(basename "${file}")" >> "${DIST_DIR}/checksums.txt"
          done

          cp deploy/manual-install.sh "${DIST_DIR}/gateway-install.sh"
          cp deploy/gateway-cleanup.sh "${DIST_DIR}/gateway-cleanup.sh"
          cp deploy/cloud-init.sh "${DIST_DIR}/cloud-init.sh"
          cp deploy/chatcode-gateway.service "${DIST_DIR}/chatcode-gateway.service"
          chmod +x "${DIST_DIR}/gateway-install.sh" "${DIST_DIR}/gateway-cleanup.sh" "${DIST_DIR}/cloud-init.sh"
          printf '%s\n' "${VERSION}" > "${DIST_DIR}/latest.txt"

          cat > "${DIST_DIR}/manifest.json" <<JSON
          {
            "version": "${VERSION}",
            "targets": ["linux/amd64", "linux/arm64", "darwin/arm64"]
          }
          JSON

      - name: Upload release bundle
        uses: actions/upload-artifact@v4
        with:
          name: gateway-release-bundle
          path: packages/gateway/dist/${{ github.ref_name }}

  github-release:
    name: Publish GitHub Release Assets
    runs-on: ubuntu-latest
    needs: bundle

    steps:
      - name: Download release bundle
        uses: actions/download-artifact@v4
        with:
          name: gateway-release-bundle
          path: dist/${{ github.ref_name }}

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ github.ref_name }}/*

  publish-r2:
    name: Publish Release Bundle to R2
    runs-on: ubuntu-latest
    needs: bundle
    env:
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_RELEASE_BUCKET: ${{ secrets.R2_RELEASE_BUCKET }}

    steps:
      - name: Check R2 publish config
        id: check
        run: |
          if [[ -n "${R2_ACCOUNT_ID}" && -n "${R2_ACCESS_KEY_ID}" && -n "${R2_SECRET_ACCESS_KEY}" && -n "${R2_RELEASE_BUCKET}" ]]; then
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          else
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "Skipping R2 publish: required secrets are missing."
          fi

      - name: Checkout
        if: ${{ steps.check.outputs.enabled == 'true' }}
        uses: actions/checkout@v4

      - name: Download release bundle
        if: ${{ steps.check.outputs.enabled == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: gateway-release-bundle
          path: packages/gateway/dist/${{ github.ref_name }}

      - name: Ensure AWS CLI
        if: ${{ steps.check.outputs.enabled == 'true' }}
        run: |
          if command -v aws >/dev/null 2>&1; then
            aws --version
            exit 0
          fi
          sudo apt-get update
          sudo apt-get install -y awscli

      - name: Verify R2 access
        if: ${{ steps.check.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          export AWS_ACCESS_KEY_ID="${R2_ACCESS_KEY_ID}"
          export AWS_SECRET_ACCESS_KEY="${R2_SECRET_ACCESS_KEY}"
          export AWS_DEFAULT_REGION="auto"
          export AWS_EC2_METADATA_DISABLED="true"

          R2_ENDPOINT="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          if ! aws --endpoint-url "${R2_ENDPOINT}" s3api head-bucket --bucket "${R2_RELEASE_BUCKET}" >/tmp/r2-head.out 2>/tmp/r2-head.err; then
            echo "::error::R2 preflight failed for bucket '${R2_RELEASE_BUCKET}'."
            echo "::error::Check R2_ACCOUNT_ID / R2_ACCESS_KEY_ID / R2_SECRET_ACCESS_KEY secrets."
            cat /tmp/r2-head.err
            exit 1
          fi
          aws --version

      - name: Publish to R2
        if: ${{ steps.check.outputs.enabled == 'true' }}
        working-directory: packages/gateway
        env:
          R2_ACCOUNT_ID: ${{ env.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID: ${{ env.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ env.R2_SECRET_ACCESS_KEY }}
          RELEASE_PREFIX: gateway
        run: ./scripts/publish-release-r2.sh "${GITHUB_REF_NAME}" "${R2_RELEASE_BUCKET}"
